extends CharacterBody3D

# REFERENCES
@onready var raycast = $Eyes/RayCast3D
@onready var eyes = $Eyes
@onready var shoot_timer = $shoot_timer
@onready var bob_timer = $bob_timer
@onready var death_timer = $death_timer
@onready var height_raycast = $HeightRayCast
@onready var model = $model.get_active_material(0)
var start_pos
@export var health: float = 100.0
@onready var death_particle = preload("res://scenes/enemy_and_parts/malware_death.tscn")
var projectile_scene = preload("res://scenes/enemy_and_parts/malware_projectile.tscn")
var idle_face = preload("res://textures/smile.png")
var angry_face = preload("res://textures/anger.png")
var is_dead = false
var target
const TURN_SPEED = 2

# STATE MACHINE
enum {
	IDLE,
	ALERT
}

var state = IDLE
var up = 1
var height

func _ready():
	start_pos = self.global_position.y
	bob_timer.start()

func _process(delta):
	var player = get_tree().get_first_node_in_group("player")
	
	eyes.look_at(player.global_position, Vector3.UP)
	rotate_y(deg_to_rad(eyes.rotation.y * TURN_SPEED))
	if raycast.is_colliding():
		var hit = raycast.get_collider()
		if hit != null:
			if hit.is_in_group("player"):
				state = ALERT
				shoot_timer.start()
		
	match state:
		IDLE:
			velocity.x = 0
			velocity.z = 0
			model.set_shader_parameter("face_text", idle_face)
		ALERT:
			#bob_timer.stop()
			model.set_shader_parameter("face_text", angry_face)
			
			var relative_position = global_position - player.global_position
			
			velocity += relative_position.normalized() * 3 * delta
			
	
	update_height()
	velocity.y += 1.5 / (height + 1)
	velocity.y -= 0.5
	#velocity.y += up * cos(velocity.y + delta)
	velocity.x = move_toward(velocity.x, 0, delta)
	velocity.z = move_toward(velocity.z, 0, delta)
	raycast.global_position.y = start_pos
	move_and_slide()
	if model.get_shader_parameter("red") >= 0.0:
		model.set_shader_parameter("red", model.get_shader_parameter("red") - delta * 1.2)
	if health <= 0.0 and not is_dead:
		explode()
		death_timer.start()
		is_dead = true
	if death_timer.is_stopped() and is_dead:
		self.queue_free()
	

func _on_sight_range_body_entered(body):
	if body.is_in_group("player"):
		state = ALERT
		target = body
		shoot_timer.start()
		print("Saw")

func _on_sight_range_body_exited(body):
	if body.is_in_group("player"):
		state = IDLE
		#bob_timer.start()
		shoot_timer.stop()
		print("Stopped seeing")

func _on_shoot_timer_timeout():
	shoot()
			
func shoot():
	var new_projectile = projectile_scene.instantiate()
	new_projectile._set_dir(-eyes.get_global_transform().basis.z * 20)
	new_projectile.position = eyes.global_position
	$"../".add_child(new_projectile)

func update_height():
	if(height_raycast.is_colliding()):
		var origin = height_raycast.global_transform.origin
		var collision_point = height_raycast.get_collision_point()
		height = origin.distance_to(collision_point)
	else:
		height = 1000000

func _on_bob_timer_timeout():
	up = -up

func take_damage():
	model.set_shader_parameter("red", 1.0);
	$sfx.play()
	health -= 33.4

func explode():
	var particle = death_particle.instantiate()
	get_node("/root/Main").add_child(particle)
	particle.global_position = self.global_position
	particle.get_child(0).emitting = true
